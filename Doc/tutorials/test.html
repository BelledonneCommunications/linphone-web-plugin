<html>
<head>
    <style type="text/css">
    </style>

	<script type="text/javascript" src="test.js"></script>
    <script type="text/JavaScript">
    
    	/* return the core object */
        function getCore(){
            return document.getElementById('core');
        }

		/* Method to create callbacks */
        function addEvent(obj, name, func){
			var browser = searchString(getDataBrowser());
            if (browser !== 'Explorer') {
                obj.addEventListener(name, func, false); 
            } else {
                obj.attachEvent('on' + name, func);
            }
        }
        
        /* Basic call */
        function call(addressStr){
        	var core = getCore();
			var address = core.newAddress(addressStr);
			if(address !== null) {
				core.inviteAddress(address);
				console.log("Call: " + address.asString());
			}
        }
        
        /* Registration */
        function registration(username,password,server){
        	var core = getCore();        	
			var proxy = core.newProxyConfig();
			var authinfo = core.newAuthInfo(username, null,password,null,null);
			core.addAuthInfo(authinfo);
			proxy.identity = 'sip:' + username + '@' + server;
			proxy.serverAddr = 'sip:' + server;
			proxy.expires = 3600;
			proxy.registerEnabled = true;
			core.addProxyConfig(proxy);
			core.defaultProxy = proxy;
        }
        
        // Remove the core object
       	function unload(){
			var core = getCore();
			delete core;
        }
        
        // Reload the test
       	function reload(){
			unload();
			load();
		}
        
        /* Main function */
        function load(){
			var config = getConfig();
			var functionName = '__loadHandler';
			var browserDetection;
			var core;
			
			navigator.plugins.refresh(false);
			window[functionName] = function (core) {
				_loadHandler(core);
				/* 
				 * We must keep the function, because if the element is hidden (core object), 
				 * when it will re-appear this function will be called again.
				 * 
				 */
			};
			
			// Find the correct plugin file
			browserDetection = browserDetect();
			config.file = {};
			if (typeof config.files[browserDetection.os] !== 'undefined') {
				if (typeof config.files[browserDetection.os][browserDetection.browser] !== 'undefined') {
					config.file.description = config.files[browserDetection.os][browserDetection.browser];
					config.file.browser = browserDetection.browser;
				} else {
					config.file.description = config.files[browserDetection.os].DEFAULT;
					config.file.browser = 'DEFAULT';
				}
			}	

			// Specific updates for Internet explorer for download the .cab file
			config.file.codebase = '';
			if (typeof config.file.description !== 'undefined') {
				if (config.file.browser === 'Explorer' ) {
					config.file.codebase = config.file.description.file;
					config.file.codebase += '#Version=' + config.file.description.version;
				}
			}
			
			// Creation of core object dynamically in order to add the codebase and the function name for the core object
			var d = document.getElementById('coreObject');
			d.innerHTML = '<object id="core" type="application/x-linphone-web" width="0" height="0" codebase=' + config.file.codebase + '>' +
	 				'<param name="onload" value=' + functionName  + '></object>'

			core = getCore();
			
			// Detection of the plugin
			var ret = detect(config,core);
			if(ret === 0){
				// Donwload the plugin
				window.open(config.file.description, '_self');	
			} 
        }
        
		function _loadHandler(core){
			core.init();
			
            /* Add callback for registration and call state */
            addEvent(core,"callStateChanged",onCallStateChanged);
            addEvent(core,"registrationStateChanged",onRegistrationStateChanged);
            
            /* Display logs information in the console */
            core.logHandler = function(level, message) {
            	window.console.log(message);
            }
            /* Start main loop for receiving notifications and doing background linphonecore work */
            core.iterateEnabled = true;
            console.log("core handler");
		}
        
        /* Callback that display call states */
        function onCallStateChanged(event, call, state, message){
            console.log(message);
        }
        
        function onRegistrationStateChanged(event, proxy, state, message){
            console.log(message);
        }
    </script>
</head>
<body onload="load()">
	<div id="coreObject">
		
	</div>
	<div class="status">
		Linphone-web
	</div>
	<div class="action">
		<input type="button" OnClick="reload()" value="Reload">
	</div>
</body>
</html>