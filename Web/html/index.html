<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Linphone-JS</title>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<link rel="icon" type="image/png" href="style/images/linphone.png" />

<link type="text/css" href="style/ui-lightness/jquery-ui-1.8.17.custom.css" rel="stylesheet" />
<link type="text/css" href="style/scrollabletab.css" rel="stylesheet" />
<link type="text/css" href="style/linphone-ui.css" rel="stylesheet" />

<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.scrollabletab.js"></script>
<script type="text/javascript" src="js/jquery.metadata.js"></script>
<script type="text/javascript" src="js/jquery.client.js"></script>
<script type="text/javascript" src="js/jsrender.js"></script>
<script type="text/javascript" src="js/i18n.js"></script>
<script type="text/javascript" src="js/linphone-core.js"></script>
<script type="text/javascript" src="js/linphone-ui.js"></script>

<style type="text/css">
body {
	font: 62.5% "Trebuchet MS", sans-serif;
}

.tabs {
	font-size: .8em !important;
	width: auto;
	margin: 5px;
	padding: 0;
	border: 0 !important;
	overflow: hidden;
}

#version {
	font-size: 9px;
}

#version_number {
	font-weight: bold;
}
</style>
</head>

<body>
	<div>
		<div class="linphone ui-widget" id="linphone">
			<div class="window ui-corner-all">
				<div class="error overall ui-corner-all">
					<div class="text"></div>
					<button type="button" onclick="refresh()">Refresh</button>
				</div>
				<div class="install overall ui-corner-all">
					<div class="text">Install !</div>
					<button type="button" onclick="refresh()">Refresh</button>
				</div>
				<div class="load ui-corner-all">
					<img src="style/images/loading.gif" alt="..."
						style="width: 50px; height: 50px; position: absolute; top: 50%; left: 50%; margin-left: -25px; margin-top: -25px;"></img>
				</div>
				<div class="header ui-corner-top">
					<div class="text">Linphone</div>
				</div>

				<div class="composer">
					<input type="text" class="dest" title="destination" />
					<div class="ui-icon dial-button"></div>
				</div>

				<div class="content">
					<div class="tabs">
						<ul>
							<li><a href="#tabs-1">First</a></li>
						</ul>
						<div id="tabs-1" class="tab">Example</div>
					</div>
				</div>

				<div class="footer ui-corner-bottom">
					<div class="status"></div>
					<div class="tools">
						<div class="ui-icon bell-icon">
							<div class="bell-slider"></div>
						</div>
						<div class="ui-icon mic-icon">
							<div class="mic-slider"></div>
						</div>
						<div class="ui-icon hp-icon">
							<div class="hp-slider"></div>
						</div>
						<div class="ui-icon settings-icon">
							<ul class="settings-menu">
								<li class="accounts"><a class="ui-icon {translate: 'menu.settings.accounts'}"></a></li>
								<li class="media"><a class="ui-icon {translate: 'menu.settings.media'}"></a></li>
								<li class="video"><a class="ui-icon {translate: 'menu.settings.video'}"></a>
									<ul class="video-menu">
										<li class="enable"><a class="{translate: 'menu.settings.video.enable'}"></a></li>
										<li class="self"><a class="{translate: 'menu.settings.video.self'}"></a></li>
									</ul></li>
								<li class="codecs"><a class="ui-icon {translate: 'menu.settings.codecs'}"></a></li>
								<li class="locales"><a class="ui-icon {translate: 'menu.settings.locales'}"></a>
									<ul class="locales-menu">
										<li></li>
									</ul></li>
							</ul>
						</div>
					</div>
				</div>
				<div class="codecs-options options ui-dialog ui-widget ui-widget-content ui-corner-all">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"
						style="-webkit-user-select: none;">
						<span class="ui-dialog-title {translate: 'menu.settings.codecs'}" style="-webkit-user-select: none;"></span> <a
							href="#" class="ui-dialog-titlebar-close ui-corner-all" style="-webkit-user-select: none;"> <span
							class="ui-icon ui-icon-closethick" style="-webkit-user-select: none;">close</span>
						</a>
					</div>
					<div class="content ui-corner-bottom">
						<div class="tabs">
							<ul>
								<li><a class="{translate: 'options.codecs.audio'}"></a></li>
								<li><a class="{translate: 'options.codecs.video'}"></a></li>
							</ul>
							<div>
								<table class="audio">
									<thead>
										<tr>
											<th class="name {translate: 'options.codecs.name'}"></th>
											<th class="frequency {translate: 'options.codecs.frequency'}"></th>
											<th class="bitrate {translate: 'options.codecs.bitrate'}"></th>
											<th class="actions {translate: 'options.codecs.actions'}"></th>
										</tr>
									</thead>
									<tbody />
								</table>
							</div>
							<div>
								<table class="video">
									<thead>
										<tr>
											<th class="name {translate: 'options.codecs.name'}"></th>
											<th class="frequency {translate: 'options.codecs.frequency'}"></th>
											<th class="bitrate {translate: 'options.codecs.bitrate'}"></th>
											<th class="actions {translate: 'options.codecs.actions'}"></th>
										</tr>
									</thead>
									<tbody />
								</table>
							</div>
						</div>
					</div>
				</div>

				<div class="media-options options ui-dialog ui-widget ui-widget-content ui-corner-all">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"
						style="-webkit-user-select: none;">
						<span class="ui-dialog-title {translate: 'menu.settings.media'}" style="-webkit-user-select: none;"></span> <a
							href="#" class="ui-dialog-titlebar-close ui-corner-all" style="-webkit-user-select: none;"> <span
							class="ui-icon ui-icon-closethick" style="-webkit-user-select: none;">close</span>
						</a>
					</div>
					<div class="content ui-corner-bottom"></div>
				</div>

				<div class="accounts-options options ui-dialog ui-widget ui-widget-content ui-corner-all">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"
						style="-webkit-user-select: none;">
						<span class="ui-dialog-title {translate: 'menu.settings.accounts'}" style="-webkit-user-select: none;"></span> <a
							href="#" class="ui-dialog-titlebar-close ui-corner-all" style="-webkit-user-select: none;"> <span
							class="ui-icon ui-icon-closethick" style="-webkit-user-select: none;">close</span>
						</a>
					</div>
					<div class="content ui-corner-bottom">
						<table class="accounts">
							<thead>
								<tr>
									<th class="name {translate: 'options.accounts.name'}"></th>
									<th class="status {translate: 'options.accounts.status'}"></th>
								</tr>
							</thead>
							<tbody />
						</table>
						<button type="button" class="add {translate: 'options.accounts.add'}"></button>
					</div>
				</div>

				<div class="account-form options ui-dialog ui-widget ui-widget-content ui-corner-all">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"
						style="-webkit-user-select: none;">
						<span class="ui-dialog-title {translate: 'form.account.title'}" style="-webkit-user-select: none;"></span> <a
							href="#" class="ui-dialog-titlebar-close ui-corner-all" style="-webkit-user-select: none;"> <span
							class="ui-icon ui-icon-closethick" style="-webkit-user-select: none;">close</span>
						</a>
					</div>
					<div class="content ui-corner-bottom">
						<label class="{translate: 'form.account.identity'}"></label>
						<span>
							<input class="identity ui-widget-content ui-corner-all"></input>
						</span>
						<label class="{translate: 'form.account.proxy'}"></label>
						<span>
							<input class="proxy ui-widget-content ui-corner-all"></input>
						</span>
						<label class="{translate: 'form.account.route'}"></label>
						<span>
							<input class="route ui-widget-content ui-corner-all"></input>
						</span>
						<label class="{translate: 'form.account.expires'}"></label>
						<span>
							<input class="expires ui-widget-content ui-corner-all"></input>
						</span>
						<label class="{translate: 'form.account.register'}"></label>
						<span>
							<input type="checkbox" class="register ui-widget-content ui-corner-all"></input>
						</span>
						<button type="button" class="remove {translate: 'form.account.remove'}"></button>
						<button type="button" class="valid {translate: 'form.account.valid'}"></button>
					</div>
				</div>
			</div>
			<div id="templates"></div>
		</div>
		<div>
			<textarea id="log" rows="10" cols="100"></textarea>
			<div class="ui-widget">
				<div id="version" class="ui-state-highlight ui-corner-all">
					Linphone version: <span id="version_number"></span>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		// Utils 
		var _objectCodeBase = ""
		if(jQuery.client.os == "Windows")
		   _objectCodeBase = "linphone-web.msi"
		else if(jQuery.client.os == "Linux" && jQuery.client.browser == "Firefox")
		   _objectCodeBase = "linphone-web.xpi"
		var _coreTemplate = '<object id="core" type="application/x-linphone-web" width="0" height="0" codebase="'+_objectCodeBase+'"> \
							 	<param name="onload" value="_coreLoad" /> \
							 	Linphone Core \
							 </object>'
		var _localData = {}
		function localData() {
			if (typeof window['localStorage'] !== 'undefined')
				return localStorage
			else
				return _localData
		}

		function consoleLog(a) {
			if (typeof window['console'] !== 'undefined') {
				console.log(a)
			}
		}

		function core() {
			return document.getElementById('core');
		}

		function _coreLoad(obj) {
			coreLoad()
		}

		function _videoLoad(obj) {
			linphone.instance.video_data[obj.magic](obj)
		}

		var _addEvent;
		if (!jQuery.browser.msie) {
			_addEvent = function(obj, name, func) {
				obj.addEventListener(name, func, false);
			}
		} else {
			_addEvent = function(obj, name, func) {
				obj.attachEvent("on" + name, func);
			}
		}

		function addEvent(obj, name, func) {
			_addEvent(obj, name, func)
		}

		function loadLinphoneI18n() {
			jQuery.i18n.data = linphone.ui.i18n
			var locale = (navigator.language) ? navigator.language : navigator.userLanguage
			locale = locale.replace('-', '_')
			consoleLog('Browser language: ' + locale)
			if (localData()['locale'] != null) {
				jQuery.i18n.change(localData()['locale'])
			} else {
				// Excat Match 
				for (a in linphone.instance.locales) {
					if (linphone.instance.locales[a].locale == locale) {
						consoleLog('Change locale: ' + linphone.instance.locales[a].locale)
						jQuery.i18n.change(linphone.instance.locales[a].locale)
						return;
					}
				}

				// Start Match 
				for (a in linphone.instance.locales) {
					if (linphone.instance.locales[a].locale.search(locale) == 0) {
						consoleLog('Change locale: ' + linphone.instance.locales[a].locale)
						jQuery.i18n.change(linphone.instance.locales[a].locale)
						return;
					}
				}

				// Take default (first) 
				jQuery.i18n.change(linphone.instance.locales[0].locale)
			}
		}

		function addLog(message) {
			jQuery('#log').val(jQuery('#log').val() + message + '\n');
		}

		// Init functions 
		function init2() {
			loadLinphoneI18n()
			populate_locales_menu()
			jQuery(".linphone .window .tools .locales-menu").menu();
		}

		function init() {
			consoleLog('Init LinphoneJS')
			try
			{
				jQuery('#templates').load('templates.html', init2)
			}catch(err) {
				//Ignore console issue in internet explorer
			}
		}

		function videoUnload(object) {
		}

		function videoError(object) {
		}

		function videoLoad(object) {
		}

		function createVideoView(title, onOpen, onClose) {
			var element = $(document.createElement('div'))
			element.attr('title', title)
			element.addClass('video')

			element.dialog({
				height : 240,
				width : 320,
				close : function() {
					onClose(jQuery(this).find('object').get(0))
				}
			})
			element.parent().appendTo(jQuery('.linphone'))
			element.dialog("open")
			var template = jQuery(jQuery('#Linphone-Video').render({
				magic : linphone.instance.video_number
			}))
			var object = template.find('object')
			consoleLog('Create VideoView ' + linphone.instance.video_number)
			linphone.instance.video_data[linphone.instance.video_number] = onOpen
			linphone.instance.video_number = linphone.instance.video_number + 1
			element.append(template)
			return element
		}

		function destroyVideoView(element) {
			var object = element.find('object').get(0)
			consoleLog('Destroy VideoView ' + object.magic)
			linphone.instance.video_data.splice(object.magic, 1);
			element.dialog('destroy')
			element.remove()
		}

		function coreLoad() {
			consoleLog('Load Core')
			jQuery('#version_number').text(core().version)
			addEvent(core(), 'globalStateChanged', globalStateChanged)
			addEvent(core(), 'callStateChanged', callStateChanged)
			addEvent(core(), 'displayStatus', displayStatus)
			addEvent(core(), 'displayMessage', displayMessage)
			addEvent(core(), 'displayWarning', displayWarning)
			addEvent(core(), 'displayUrl', displayUrl)
			var ret_value = core().init()
			if (ret_value != 0) {
				error(jQuery.i18n.get('errors.core.' + ret_value))
			} else {
				// Init volumes settings 
				rec_level = (localData()['rec_level'] != null) ? localData()['rec_level'] : 100
				jQuery('.linphone .window .tools .mic-slider').slider('value', rec_level)
				core().setRecLevel(rec_level)

				play_level = (localData()['play_level'] != null) ? localData()['play_level'] : 100
				jQuery('.linphone .window .tools .hp-slider').slider('value', play_level)
				core().setPlayLevel(play_level)

				ring_level = (localData()['ring_level'] != null) ? localData()['ring_level'] : 100
				jQuery('.linphone .window .tools .bell-slider').slider('value', ring_level)
				core().setRingLevel(ring_level)

				// Init video settings 
				if (localData()['enable_video'] == 1) {
					core().enableVideo(true)
				} else if (localData()['enable_video'] == 0) {
					core().enableVideo(false)
				} else {
					localData()['enable_video'] = 1
					core().enableVideo(true)
				}

				addLog('Sip port: ' + core().sip_port)

				jQuery('.linphone .window .load').hide()

				updateSelfView()
				updateVideoView()
			}
		}

		function updateVideoView() {
			if (localData()['enable_video'] == 1) {
				linphone.instance.video_view = createVideoView('video', function(object) {
					consoleLog('Load VideoView ' + object.magic)
					object.setBackgroundColor(0, 0, 0)
					core().setNativeVideoWindowId(object.window)
					core().enableVideo(true)
				}, function(object) {
					localData()['enable_video'] = 0
					updateSelfView()
				})
			} else {
				if (linphone.instance.video_view != null) {
					core().enableVideo(false)
					core().setNativeVideoWindowId(0)
					destroyVideoView(linphone.instance.video_view)
					linphone.instance.video_view = null
				}
			}
		}

		function updateSelfView() {
			if (localData()['enable_video'] == 1 && localData()['enable_video_self'] == 1) {
				linphone.instance.self_view = createVideoView('locale', function(object) {
					consoleLog('Load VideoView ' + object.magic)
					object.setBackgroundColor(0, 0, 0)
					core().setNativePreviewWindowId(object.window)
					core().enableVideoPreview(true)
				}, function(object) {
					localData()['enable_video_self'] = 0
					updateSelfView()
				})
			} else {
				if (linphone.self_view != null) {
					core().enableVideoPreview(false)
					core().setNativePreviewWindowId(0)
					destroyVideoView(linphone.instance.self_view)
					linphone.instance.self_view = null
				}
			}
		}
		
		function refreshAccountList() {
			table = jQuery('.linphone .window .accounts-options .content tbody')
			data = core().getProxyConfigList()
			table.empty()
			for (a in data) {
				var item = data[a]
				var element = jQuery(jQuery('#Linphone-AccountsList').render(item))
				element.data('data', item)
				table.append(element)
			}
			
			jQuery('.linphone .window .accounts-options .content tbody tr').hover(function() {
				jQuery(this).addClass("ui-state-highlight");
			}, function() {
				jQuery(this).removeClass("ui-state-highlight");
			})
		}

		function globalStateChanged(state, message) {
			addLog('State(' + state + '): ' + message)
			jQuery('.linphone .window > .footer > .status').html(
					jQuery.i18n.get('globalstatetext.' + linphone.core.enum.getGlobalStateText(state)))
		}

		function callStateChanged(call, state, message) {
			addLog('Call(' + state + '): ' + message);
			if (state == LinphoneCallState.Connected) {

			} else if (state == LinphoneCallState.IncomingReceived) {
				create_call(call, '#Linphone-Call-IncomingReceived')
			}

			var element = findCallTab(call);
			if (element) {
				var content = jQuery('#Linphone-Call-' + linphone.core.enum.getCallStateText(state)).render(element.data('data'))
				element.html(content)
				jQuery.i18n.update(element, true)
			} else {
				addLog('Can\'t find call tab: ' + call);
			}
		}

		function displayStatus(message) {
			addLog('Status: ' + message);
		}

		function displayMessage(message) {
			addLog('Message: ' + message);
		}

		function displayWarning(message) {
			addLog('Warning: ' + message);
		}

		function displayUrl(message, url) {
			addLog('Url: ' + message + ' - ' + url);
		}

		function findCallTab(obj) {
			var ret = null
			jQuery('#linphone .window > .content .tabs .tab').each(function(index) {
				var element = jQuery(this)
				if (element.data('data') && element.data('data') == obj) {
					ret = element;
				}
			})
			return ret;
		}

		function call_invite(dest) {
			core().invite_async(dest, function() {
				return function(plugin, obj) {
					call_invite_callback(dest, obj)
				}
			}())
		}

		function create_call(obj, template) {
			if (obj) {
				var call_number = linphone.instance.call_number
				consoleLog('Add tab call-' + call_number)
				var div = jQuery('<div id="call-'+call_number+'" class="tab"></div>')
				jQuery('#linphone .window > .content .tabs').append(div).tabs('add', '#call-' + call_number,
						'Call ' + call_number);
				jQuery('#linphone .window > .content .tabs').tabs('select', '#call-' + call_number)
				var element = jQuery('#linphone .window > .content .tabs #call-' + call_number)
				element.data('data', obj)
				
				var content = jQuery(template).render(obj)
				element.html(content)
				jQuery.i18n.update(element, true)
				linphone.instance.call_number++
			}
		}
		
		function call_invite_callback(dest, obj) {
			create_call(obj, '#Linphone-Call-OutgoingInit')
		}

		function populate_locales_menu() {
			// Locales
			var menu = jQuery('.linphone .window .tools .locales-menu')
			menu.empty()
			for (a in linphone.ui.locales) {
				var item = linphone.ui.locales[a]
				var element = jQuery(jQuery('#Linphone-LocaleItem').render(item))
				element.find('a').data('data', item)
				menu.append(element)
			}
		}
		
		jQuery.views.registerHelpers({
			getLinphoneRegistrationStateText: function(val) {
				return linphone.core.enum.getRegistrationStateText(val);
			}
		});
		
		jQuery(function() {

			jQuery.fn.disableSelection = function() {
				return this.each(function() {
					$(this).attr('unselectable', 'on').css({
						'-moz-user-select' : 'none',
						'-webkit-user-select' : 'none',
						'user-select' : 'none',
						'-ms-user-select' : 'none'
					}).each(function() {
						this.onselectstart = function() {
							return false;
						};
					});
				});
			};

			linphone.instance = {}
			linphone.instance.call_number = 1
			linphone.instance.video_number = 1
			linphone.instance.video_data = new Array()
			linphone.instance.self_view = null
			linphone.instance.video_view = null
			linphone.instance.current_proxy_config = null
			
			// Tabs 
			jQuery('.linphone .window > .content .tabs').tabs({
				closable : true,
				scrollable : true
			})

			jQuery(".linphone .window .codecs-options .content .tabs > ul li a").each(function(index) {
				jQuery(this).attr("href", "#codecs" + index.toString());
			});
			jQuery(".linphone .window .codecs-options .content .tabs > div").each(function(index) {
				jQuery(this).attr("id", "codecs" + index.toString());
			})
			// Tabs 
			jQuery('.linphone .window .codecs-options .content .tabs').tabs({})

			jQuery(".linphone .window .tools .hp-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					if (localData())
						localData()['play_level'] = ui.value
					core().setPlayLevel(ui.value)
				}
			});
			jQuery(".linphone .window .tools .mic-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					if (localData())
						localData()['rec_level'] = ui.value
					core().setRecLevel(ui.value)
				}
			});
			jQuery(".linphone .window .tools .bell-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					if (localData())
						localData()['ring_level'] = ui.value
					core().setRingLevel(ui.value)
				}
			});

			jQuery(document).on('click', '.linphone .window .dial-button', function(event) {
				call_invite(jQuery(event.target).parent().find('.dest').val())
			})
			
			jQuery(document).on('click', '.linphone .window .answer-button', function(event) {
				element = jQuery(event.target).parents('.tab')
				if (element && element.data('data')) {
					core().acceptCall(element.data('data'))
				} else {
					addLog('Can\'t find call: ' + element);
				}
			})

			jQuery(document).on('click', '.linphone .window .teminate-button', function(event) {
				element = jQuery(event.target).parents('.tab')
				if (element && element.data('data')) {
					core().terminateCall(element.data('data'))
				} else {
					addLog('Can\'t find call: ' + element);
				}
			})

			jQuery(document).on('click', '.linphone .window .ui-tabs-close .ui-icon', function(event) {
				var tab = jQuery(event.target).parents('li')
				var tabId = tab.find('a').attr('href')
				var element = jQuery('#linphone > .window > .content .tabs ' + tabId)
				if (element && element.data('data')) {
					core().terminateCall(element.data('data'))
				} else {
					addLog('Can\'t find call: ' + element);
				}
				jQuery('#linphone .window > .content .tabs ').tabs('remove', tab.prevAll('li').length)
			})

			jQuery(document).on('click', '.linphone .window .accounts-options .add', function(event) {
				linphone.instance.current_proxy_config = null
				jQuery('.linphone .window .account-form .content button.remove').hide()
				jQuery('.linphone .window .account-form .content input.identity').val("sip:")
				jQuery('.linphone .window .account-form .content input.proxy').val("sip:")
				jQuery('.linphone .window .account-form .content input.route').val("")
				jQuery('.linphone .window .account-form .content input.expires').val("3600")
				jQuery('.linphone .window .account-form .content input.register').attr('checked', true);
				jQuery('.linphone .window .account-form').fadeIn('fast');
			})
			
			jQuery(document).on('click', '.linphone .window .accounts-options .content tbody tr', function(event) {
				data = jQuery(this).data('data')
				linphone.instance.current_proxy_config = data
				jQuery('.linphone .window .account-form .content button.remove').show()
				jQuery('.linphone .window .account-form .content input.identity').val(data.getIdentity())
				jQuery('.linphone .window .account-form .content input.proxy').val(data.getServerAddr())
				jQuery('.linphone .window .account-form .content input.route').val(data.getRoute())
				jQuery('.linphone .window .account-form .content input.expires').val(data.getExpires())
				jQuery('.linphone .window .account-form .content input.register').attr('checked', data.registerEnabled())
				jQuery('.linphone .window .account-form').fadeIn('fast');
			})
			
			jQuery(document).on('click', '.linphone .window .account-form .remove', function(event) {
				consoleLog('Remove ProxyConfig')
				var proxyConfig = linphone.instance.current_proxy_config
				core().removeProxyConfig(proxyConfig)
				
				refreshAccountList()
				jQuery('.linphone .window .account-form').fadeOut('fast');
			})
			
			jQuery(document).on('click', '.linphone .window .account-form .valid', function(event) {
					var errors = ""
					var identity_regex = new RegExp('sip:.+@.+')
					var identity = jQuery('.linphone .window .account-form .content input.identity').val()
					var proxy_regex = new RegExp('sip:.+')
					var proxy = jQuery('.linphone .window .account-form .content input.proxy').val()
					var route_regex = new RegExp('.*')
					var route = jQuery('.linphone .window .account-form .content input.route').val()
					var expires_regex = new RegExp('\\d+')
					var expires = jQuery('.linphone .window .account-form .content input.expires').val()
					var register = jQuery('.linphone .window .account-form .content input.register').is(':checked')
					
					if(identity_regex.exec(identity) == null) {
						errors += '<li class="{translate: \'form.account.errors.identity\'}"></li>'
					}
					if(proxy_regex.exec(proxy) == null) {
						errors += '<li class="{translate: \'form.account.errors.proxy\'}"></li>'
					}		
					if(route_regex.exec(route) == null) {
						errors += '<li class="{translate: \'form.account.errors.route\'}"></li>'
					}
					if(expires_regex.exec(expires) == null) {
						errors += '<li class="{translate: \'form.account.errors.duration\'}"></li>'
					}
					if(errors.length > 0) {
						errors = '<div>' + '<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span><div class="{translate: \'form.account.errors.message\'}"></div><ul>' + errors + '</ul></div>'
						var dialog = jQuery(errors)
						jQuery.i18n.update(dialog, true)
						dialog.dialog({
							title: jQuery.i18n.get('form.account.errors.title'),
							modal: false,
							buttons: {
								Ok: function() {
									$( this ).dialog( "close" );
								}
							}
						});
						return;	
					}
					
					var proxyConfig = null
					if(linphone.instance.current_proxy_config == null) {
						consoleLog('New ProxyConfig')
						proxyConfig = core().newProxyConfig()
					} else {
						consoleLog('Use ProxyConfig')
						proxyConfig = linphone.instance.current_proxy_config
						linphone.instance.current_proxy_config.edit()
					}
					
					// Set values 
					proxyConfig.setIdentity(identity)
					proxyConfig.setServerAddr(proxy)
					proxyConfig.setRoute(route)
					proxyConfig.setExpires(expires)
					proxyConfig.enableRegister(register)
					
					if(linphone.instance.current_proxy_config == null) {
						core().addProxyConfig(proxyConfig)
					} else {
						linphone.instance.current_proxy_config.done()
					}
					
					refreshAccountList()
					jQuery('.linphone .window .account-form').fadeOut('fast');
			})
		
			jQuery( ".linphone .window button" ).button();
			jQuery('.linphone .window .tools .settings-menu').menu()

			jQuery('.linphone .window .tools .video-menu').menu()

			jQuery('.linphone .window .tools').disableSelection()

			jQuery('.linphone .window .options .ui-dialog-titlebar').disableSelection()

			jQuery('.linphone .window .options .ui-dialog-titlebar-close').click(function(event) {
				jQuery(this).parents('.options').fadeOut('fast')
			})

			jQuery('.linphone .window .options .ui-dialog-titlebar-close').hover(function() {
				jQuery(this).addClass("ui-state-hover");
			}, function() {
				jQuery(this).removeClass("ui-state-hover");
			})

			var dnd = {}

			function updateCodecsList(table) {
				data = new Array()
				table.find('tbody tr').each(function() {
					data.push(jQuery(this).data('data'))
				})
				consoleLog(data)
				if (table.is('.linphone .window .codecs-options .content .video')) {
					core().setVideoCodecs(data)
				} else if (table.is('.linphone .window .codecs-options .content .audio')) {
					core().setAudioCodecs(data)
				}
			}

			jQuery('html').click(function(event) {
				var target = jQuery(event.target);

				if (!target.is('.linphone .window .tools .hp-icon'))
					jQuery('.linphone .window .tools .hp-slider').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .hp-slider').fadeToggle('fast');

				if (!target.is('.linphone .window .tools .mic-icon'))
					jQuery('.linphone .window .tools .mic-slider').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .mic-slider').fadeToggle('fast');

				if (!target.is('.linphone .window .tools .bell-icon'))
					jQuery('.linphone .window .tools .bell-slider').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .bell-slider').fadeToggle('fast');

				// Click on settings 
				if (target.is('.linphone .window .tools .settings-icon'))
					jQuery('.linphone .window .tools .settings-menu').fadeToggle('fast');
				else if (target.parents(".linphone .window .tools .settings-icon").length == 0)
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .settings-menu').fadeIn('fast');

				// Click on locale item 
				if (target.is('.linphone .window .tools .locales > a')) {
					// Update selected element 
					jQuery('.linphone .window .tools .locales-menu .flag').each(function(index) {
						var element = $(this)
						if (element.data('data').locale == jQuery.i18n.locale) {
							element.addClass('ui-state-selected')
						} else {
							element.removeClass('ui-state-selected')
						}
					})
					jQuery('.linphone .window .tools .locales-menu').fadeToggle('fast');
				} else if (target.parents(".linphone .window .tools .locales").length == 0)
					jQuery('.linphone .window .tools .locales-menu').fadeOut('fast');
				else {
					jQuery('.linphone .window .tools .locales-menu').fadeIn('fast');
				}

				// Click on video item 
				if (target.is('.linphone .window .tools .video > a')) {
					if (localData()['enable_video'] == 1) {
						jQuery('.linphone .window .tools .video-menu .enable a').addClass('ui-state-selected')
						jQuery('.linphone .window .tools .video-menu .self a').removeClass('ui-state-disabled')
					} else {
						jQuery('.linphone .window .tools .video-menu .enable a').removeClass('ui-state-selected')
						jQuery('.linphone .window .tools .video-menu .self a').addClass('ui-state-disabled')
					}
					if (localData()['enable_video_self'] == 1) {
						jQuery('.linphone .window .tools .video-menu .self a').addClass('ui-state-selected')
					} else {
						jQuery('.linphone .window .tools .video-menu .self a').removeClass('ui-state-selected')
					}
					jQuery('.linphone .window .tools .video-menu').fadeToggle('fast');
				} else if (target.parents(".linphone .window .tools .video").length == 0)
					jQuery('.linphone .window .tools .video-menu').fadeOut('fast');
				else {
					jQuery('.linphone .window .tools .video-menu').fadeIn('fast');
				}

				// Click on enable video item 
				if (target.is('.linphone .window .tools .video-menu .enable > a')) {
					if (jQuery('.linphone .window .tools .video-menu .enable > a').hasClass('ui-state-selected')) {
						localData()['enable_video'] = 0
						core().enableVideo(false)
					} else {
						localData()['enable_video'] = 1
						core().enableVideo(true)
					}
					updateSelfView()
					jQuery('.linphone .window .tools .video-menu').fadeOut('fast');
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
				}

				// Click on self view video item 
				if (target.is('.linphone .window .tools .video-menu .self > a')) {
					if (jQuery('.linphone .window .tools .video-menu .self > a').hasClass('ui-state-selected')) {
						localData()['enable_video_self'] = 0
					} else {
						localData()['enable_video_self'] = 1
					}
					updateSelfView()
					jQuery('.linphone .window .tools .video-menu').fadeOut('fast');
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
				}

				// Click on a locale 
				if (target.is('.linphone .window .tools .locales-menu a')) {
					jQuery('.linphone .window .tools .locales-menu').fadeOut('fast');
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					jQuery.i18n.change(target.data('data').locale)
					localData()['locale'] = target.data('data').locale
				}

				// Click on account item 
				if (target.is('.linphone .window .tools .accounts > a')) {
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					
					refreshAccountList()
					
					jQuery('.linphone .window .accounts-options').fadeIn('fast');
				}

				// Click on codecs item 
				if (target.is('.linphone .window .tools .codecs > a')) {
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					{
						table = jQuery('.linphone .window .codecs-options .content .audio tbody')
						data = core().getAudioCodecs()
						table.empty()
						for (a in data) {
							var item = data[a]
							var element = jQuery(jQuery('#Linphone-CodecsList').render(item))
							element.data('data', item)
							table.append(element)
						}
					}
					{
						table = jQuery('.linphone .window .codecs-options .content .video tbody')
						data = core().getVideoCodecs()
						table.empty()
						for (a in data) {
							var item = data[a]
							var element = jQuery(jQuery('#Linphone-CodecsList').render(item))
							element.data('data', item)
							table.append(element)
						}
					}

					jQuery(".linphone .window .codecs-options .content tbody tr").disableSelection()
					jQuery(".linphone .window .codecs-options .content tbody tr").draggable({
						containment : 'parent',
						helper : function(event) {
							original_tr = jQuery(event.target).parent()
							original_table = original_tr.parents('table')
							return original_tr.clone().css({
								"height" : original_tr.outerHeight(),
								"width" : original_tr.outerWidth(),
								"position" : "absolute"
							})
						},
						start : function(event, ui) {
							dnd.tr = this;
							dnd.helper = ui.helper;
						}
					});
					jQuery(".linphone .window .codecs-options .content tbody tr").droppable({
						drop : function(event, ui) {
							jQuery(dnd.tr).detach().insertBefore(jQuery(this));
							jQuery(dnd.helper).remove();
							updateCodecsList(jQuery(this).parents('table'))
						}
					});
					jQuery('.linphone .window .codecs-options').fadeIn('fast');
				}

				// Click on media item 
				if (target.is('.linphone .window .tools .media > a')) {
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					jQuery('.linphone .window .media-options').fadeIn('fast');
				}

				// Click on media item 
				if (target.is('.linphone .window .codecs-options input')) {
					data = target.parents('tr').data('data')
					data.enabled = !data.enabled
				}
			});
			
			init()
			refresh()
		})

		function detect() {
			if (typeof core() !== 'undefined' && typeof core().valid !== 'undefined' && core().valid) {
				jQuery('.linphone .window .install').hide()
				jQuery('.linphone .window .load').show()
				return true
			} else {
				if(jQuery.client.os == "Linux" && jQuery.client.browser == "Firefox") {
					if (InstallTrigger.updateEnabled())
  						InstallTrigger.install({"Linphone Web": _objectCodeBase});
				}
			}
			return false
		}

		function refresh() {
			jQuery('.linphone .window .error').hide()
			jQuery('#core').remove()
			navigator.plugins.refresh(false);
			var core = jQuery(_coreTemplate)
			core.appendTo(jQuery('.linphone'))
			detect()
		}

		function error(msg) {
			jQuery('.linphone .window .load').hide()
			jQuery('.linphone .window .error .text').html(msg)
			jQuery('.linphone .window .error').show()
		}
	</script>
</body>
</html>
