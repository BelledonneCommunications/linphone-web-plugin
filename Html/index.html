<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Linphone-JS</title>
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<link rel="icon" type="image/png" href="css/images/linphone.png" />

<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.17.custom.css" rel="stylesheet" />
<link type="text/css" href="css/linphone.css" rel="stylesheet" />

<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.scrollabletab.js"></script>
<script type="text/javascript" src="js/i18n.js"></script>
<script type="text/javascript" src="js/jsrender.js"></script>
<script type="text/javascript" src="js/linphone.js"></script>
<script type="text/javascript" src="js/linphone.i18n.js"></script>
<style type="text/css">
body {
	font: 62.5% "Trebuchet MS", sans-serif;
}

.tabs {
	font-size: .8em !important;
	width: auto;
	margin: 5px;
	padding: 0;
	border: 0 !important;
	overflow: hidden;
}

/*scrollable tabs css*/
.ui-scrollable-tabs {
	overflow: hidden;
	position: relative;
}

.ui-scrollable-tabs .ui-tabs-nav {
	width: 1000000px;
	padding: 1px 0 0 1px;
	border-left: none;
	border-right: none;
	padding-top: 1px;
	position: relative;
}

.ui-scrollable-tabs .ui-tabs .ui-tabs-closable li a {
	padding-right: 5px;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows {
	left: 0;
	margin: 0;
	margin: 0 5px;
	padding: 0;
	position: absolute;
	right: 0;
	top: 5px;
	height: 25px;
}

/*IE7 fix*/
*:first-child+html .ui-scrollable-tabs .ui-tabs-nav-arrows {
	z-index: 1;
}

.ui-scrollable-tabs .ui-tabs .ui-tabs-nav li {
	margin: 0 1px 0;
}

.ui-tabs-nav li .ui-tabs-close {
	float: left;
	margin-top: 3px;
	margin-right: 4px;
	border: none;
	cursor: pointer;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows .ui-tabs-arrow-next {
	float: right;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows .ui-tabs-arrow-previous {
	float: left;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows li {
	list-style: none;
	position: relative;
	cursor: pointer;
	margin: 0;
	padding: 0;
	display: none;
	z-index: 1;
	height: 23px;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows li a {
	display: block;
	margin-top: 3px;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows li a:focus {
	outline: 0px;
}

/*End of scrollable tabs css*/
#version {
	font-size: 9px;
}

#version_number {
	font-weight: bold;
}
</style>
</head>
<body>
	<script type="text/javascript">
		function plugin0() {
			return document.getElementById('plugin0');
		}
		plugin = plugin0;

		function loadLinphoneI18n() {
			jQuery.i18n.data = jQuery.linphone.i18n
			var locale = (navigator.language) ? navigator.language : navigator.userLanguage
			locale = locale.replace('-', '_')
			console.log('Browser language: ' + locale)

			// Excat Match
			for (a in jQuery.linphone.locales) {
				if (jQuery.linphone.locales[a].locale == locale) {
					jQuery.i18n.change(jQuery.linphone.locales[a].locale)
					return;
				}
			}

			// Start Match
			for (a in jQuery.linphone.locales) {
				if (jQuery.linphone.locales[a].locale.search(locale) == 0) {
					jQuery.i18n.change(jQuery.linphone.locales[a].locale)
					return;
				}
			}

			// Take default (first)
			jQuery.i18n.change(jQuery.linphone.locales[0].locale)
		}

		loadLinphoneI18n();

		function addEvent(obj, name, func) {
			if (window.addEventListener) {
				obj.addEventListener(name, func, false);
			} else {
				obj.attachEvent("on" + name, func);
			}
		}

		function addLog(message) {
			jQuery('#log').val(jQuery('#log').val() + message + '\n');
		}

		function pluginError() {
			jQuery('.linphone .window .load').hide()
			jQuery('.linphone .window .error').show()
		}
		function pluginLoaded() {
			jQuery('#version_number').text(plugin().version);
			addEvent(plugin(), 'global_state_changed', global_state_changed);
			addEvent(plugin(), 'call_state_changed', call_state_changed);
			addEvent(plugin(), 'display_status', display_status);
			addEvent(plugin(), 'display_message', display_message);
			addEvent(plugin(), 'display_warning', display_warning);
			addEvent(plugin(), 'display_url', display_url);
			if (plugin().init() != 0) {
				jQuery('.linphone .window .load').hide()
				jQuery('.linphone .window .error').show()
			} else {
				// Init volumes 
				rec_level = (localStorage != null && localStorage['rec_level'] != null) ? localStorage['rec_level']
						: 100
				jQuery('.linphone .window .tools .mic-slider').slider('value', rec_level)
				plugin().set_rec_level(rec_level)

				play_level = (localStorage != null && localStorage['play_level'] != null) ? localStorage['play_level']
						: 100
				jQuery('.linphone .window .tools .hp-slider').slider('value', play_level)
				plugin().set_play_level(play_level)

				ring_level = (localStorage != null && localStorage['ring_level'] != null) ? localStorage['ring_level']
						: 100
				jQuery('.linphone .window .tools .bell-slider').slider('value', ring_level)
				plugin().set_ring_level(ring_level)

				addLog('Sip port: ' + plugin().sip_port)

				jQuery('.linphone .window .load').hide()
			}
		}

		function global_state_changed(state, message) {
			addLog('State(' + state + '): ' + message)
			jQuery('.linphone .window .status').html(
					jQuery.i18n.get('globalstatetext.' + LinphoneGlobalStateText[state]))
		}

		function call_state_changed(call, state, message) {
			addLog('Call(' + state + '): ' + message);
			var element = findCallTab(call);
			if (element) {
				element.html(jQuery('#LinphoneCall-' + LinphoneCallStateText[state]).render(element.data('data')))
			} else {
				addLog('Can\'t find call tab: ' + call);
			}
		}

		//registration_state_changed(LinphoneProxyConfig *cfg, LinphoneRegistrationState cstate, const char *message);
		//call_state_changed(LinphoneCall *call, LinphoneCallState cstate, const char *message);
		//notify_presence_recv(LinphoneFriend * lf);
		//new_subscription_request(LinphoneFriend *lf, const char *url);
		//auth_info_requested(const char *realm, const char *username);
		//call_log_updated(LinphoneCallLog *newcl);
		//text_received(LinphoneChatRoom *room, const LinphoneAddress *from, const char *message);
		//dtmf_received(LinphoneCall *call, int dtmf);
		//refer_received(const char *refer_to);
		//buddy_info_updated(LinphoneFriend *lf);
		//notify_recv(LinphoneCall *call, const char *from, const char *event);
		function display_status(message) {
			addLog('Status: ' + message);
		}

		function display_message(message) {
			addLog('Message: ' + message);
		}

		function display_warning(message) {
			addLog('Warning: ' + message);
		}

		function display_url(message, url) {
			addLog('Url: ' + message + ' - ' + url);
		}

		function findCallTab(obj) {
			var ret = null
			jQuery('#linphone .window .tabs .tab').each(function(index) {
				var element = jQuery(this)
				if (element.data('data') && element.data('data').obj == obj) {
					ret = element;
				}
			})
			return ret;
		}

		function call_invite(dest) {
			plugin().invite_async(dest, function() {
				return function(plugin, obj) {
					call_invite_callback(dest, obj)
				}
			}())
		}

		function call_invite_callback(dest, obj) {
			console.log("call_invite_callback")
			console.log(dest)
			console.log(obj)
			if (obj) {
				var call_number = jQuery.linphone.call_number
				console.log('Add tab call-' + call_number)
				var div = jQuery('<div id="call-'+call_number+'" class="tab"></div>')
				jQuery('#linphone .window .tabs').append(div)
						.tabs('add', '#call-' + call_number, 'Call ' + call_number);
				jQuery('#linphone .window .tabs').tabs('select', '#call-' + call_number)
				var element = jQuery('#linphone .window .tabs #call-' + call_number)
				element.data('data', {
					obj : obj,
					dest : dest
				})
				element.html(jQuery('#LinphoneCall-OutgoingInit').render(element.data('data'))) //Async invite force OutgoingInit 
				jQuery.linphone.call_number++
			}
		}

		function populate_locales_menu() {
			// Locales
			var menu = jQuery('.linphone .window .tools .locales-menu')
			menu.empty()
			for (a in jQuery.linphone.locales) {
				var item = jQuery.linphone.locales[a]
				var li_item = $(document.createElement('li'))
				var a_item = $(document.createElement('a'))
				var div_item = $(document.createElement('div'))
				div_item.addClass('ui-icon')
				div_item.addClass('flag')
				div_item.css('background-image', 'url(\'' + item.icon + '\')')
				div_item.text(item.name)
				div_item.data('data', item)

				a_item.append(div_item)
				li_item.append(a_item)
				menu.append(li_item)
			}
		}

		jQuery(function() {

			jQuery.fn.disableSelection = function() {
				return this.each(function() {
					$(this).attr('unselectable', 'on').css({
						'-moz-user-select' : 'none',
						'-webkit-user-select' : 'none',
						'user-select' : 'none',
						'-ms-user-select' : 'none'
					}).each(function() {
						this.onselectstart = function() {
							return false;
						};
					});
				});
			};

			jQuery.linphone.call_number = 1

			populate_locales_menu();

			// Tabs
			jQuery('.linphone .window .tabs').tabs({
				closable : true,
				scrollable : true
			})

			jQuery(".linphone .window .tools .hp-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					if (localStorage)
						localStorage['play_level'] = ui.value
					plugin().set_play_level(ui.value)
				}
			});
			jQuery(".linphone .window .tools .mic-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					if (localStorage)
						localStorage['rec_level'] = ui.value
					plugin().set_rec_level(ui.value)
				}
			});
			jQuery(".linphone .window .tools .bell-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					if (localStorage)
						localStorage['ring_level'] = ui.value
					plugin().set_ring_level(ui.value)
				}
			});

			jQuery(document).on('click', '.linphone .window .dial-button', function(event) {
				call_invite(jQuery(event.target).parent().find('.dest').val())
			})

			jQuery(document).on('click', '.linphone .window .teminate-button', function(event) {
				element = jQuery(event.target).parents('.tab')
				if (element && element.data('data')) {
					plugin().terminate_call(element.data('data').obj)
				} else {
					addLog('Can\'t find call: ' + element);
				}
			})

			jQuery(document).on('click', '.linphone .window .ui-tabs-close .ui-icon', function(event) {
				var tab = jQuery(event.target).parents('li')
				var tabId = tab.find('a').attr('href')
				var element = jQuery('#linphone .window .tabs ' + tabId)
				if (element && element.data('data')) {
					plugin().terminate_call(element.data('data').obj)
				} else {
					addLog('Can\'t find call: ' + element);
				}
				jQuery('#linphone .window .tabs ').tabs('remove', tab.prevAll('li').length);
			})

			jQuery(".linphone .window .tools .settings-menu").menu();

			jQuery(".linphone .window .tools .locales-menu").menu();

			jQuery('.linphone .window .tools').disableSelection()

			jQuery('.linphone .window .options .close').click(function(event) {
				var element = jQuery('.linphone .window .options')
				element.fadeOut('fast');
			})

			jQuery('.linphone .window .options .close').hover(function() {
				jQuery(this).addClass("ui-state-hover");
			}, function() {
				jQuery(this).removeClass("ui-state-hover");
			})

			jQuery('html').click(function(event) {
				var target = jQuery(event.target);
				if (!target.is('.linphone .window .tools .hp-icon'))
					jQuery('.linphone .window .tools .hp-slider').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .hp-slider').fadeToggle('fast');

				if (!target.is('.linphone .window .tools .mic-icon'))
					jQuery('.linphone .window .tools .mic-slider').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .mic-slider').fadeToggle('fast');

				if (!target.is('.linphone .window .tools .bell-icon'))
					jQuery('.linphone .window .tools .bell-slider').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .bell-slider').fadeToggle('fast');

				if (target.is('.linphone .window .tools .settings-icon'))
					jQuery('.linphone .window .tools .settings-menu').fadeToggle('fast');
				else if (target.parents(".linphone .window .tools .settings-icon").length == 0)
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
				else
					jQuery('.linphone .window .tools .settings-menu').fadeIn('fast');

				if (target.is('.linphone .window .tools .locales-icon')) {
					// Update selected element 
					jQuery('.linphone .window .tools .locales-menu .flag').each(function(index) {
						var element = $(this)
						if (element.data('data').locale == jQuery.i18n.locale) {
							element.addClass('ui-state-selected')
						} else {
							element.removeClass('ui-state-selected')
						}
					})
					jQuery('.linphone .window .tools .locales-menu').fadeToggle('fast');
				} else if (target.parents(".linphone .window .tools .locales-icon").length == 0)
					jQuery('.linphone .window .tools .locales-menu').fadeOut('fast');
				else {
					jQuery('.linphone .window .tools .locales-menu').fadeIn('fast');
				}

				if (target.is('.linphone .window .tools .locales-menu .flag')) {
					jQuery('.linphone .window .tools .locales-menu').fadeOut('fast');
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					jQuery.i18n.change(target.data('data').locale)
				}

				if (target.is('.linphone .window .tools .accounts-icon')) {
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					jQuery('.linphone .window .accounts-options').fadeIn('fast');
				}

				if (target.is('.linphone .window .tools .codecs-icon')) {
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					jQuery('.linphone .window .codecs-options').fadeIn('fast');

				}

				if (target.is('.linphone .window .tools .media-icon')) {
					jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
					jQuery('.linphone .window .media-options').fadeIn('fast');
				}
			});
		})
	</script>
	<script id="LinphoneCall-Idle" type="text/x-jquery-tmpl">
Idle <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-IncomingReceived" type="text/x-jquery-tmpl">
IncomingReceived <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-OutgoingInit" type="text/x-jquery-tmpl">
OutgoingInit <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-OutgoingProgress" type="text/x-jquery-tmpl">
OutgoingProgress <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-OutgoingRinging" type="text/x-jquery-tmpl">
OutgoingRinging <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-OutgoingEarlyMedia" type="text/x-jquery-tmpl">
OutgoingEarlyMedia <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Connected" type="text/x-jquery-tmpl">
Connected <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-StreamsRunning" type="text/x-jquery-tmpl">
StreamsRunning <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Pausing" type="text/x-jquery-tmpl">
Pausing <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Paused" type="text/x-jquery-tmpl">
Paused <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Resuming" type="text/x-jquery-tmpl">
Resuming <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Refered" type="text/x-jquery-tmpl">
Refered <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Error" type="text/x-jquery-tmpl">
Error <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-End" type="text/x-jquery-tmpl">
End <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-PausedByRemote" type="text/x-jquery-tmpl">
PausedByRemote <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-UpdatedByRemote" type="text/x-jquery-tmpl">
UpdatedByRemote <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-IncomingEarlyMedia" type="text/x-jquery-tmpl">
IncomingEarlyMedia <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Updated" type="text/x-jquery-tmpl">
Updated <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Released" type="text/x-jquery-tmpl">
Call end: <b>{{=dest}}</b>
</script>

	<div>
		<object id="plugin0" type="application/x-linphone" width="0" height="0">
			<param name="onload" value="pluginLoaded" />
			<param name="onerror" value="pluginError" />
		</object>
		<br />

		<div class="linphone ui-widget" id="linphone">
			<div class="window ui-corner-all">
				<div class="error ui-corner-all"><b>Error !</b></div>
				<div class="load ui-corner-all">
					<img src="css/images/loading.gif"
						style="width: 50px; height: 50px; position: absolute; top: 50%; left: 50%; margin-left: -25px; margin-top: -25px;"></img>
				</div>
				<div class="header ui-corner-top">
					<div class="text">Linphone</div>
				</div>

				<div class="composer">
					<input type="text" class="dest" title="destination" />
					<div class="ui-icon dial-button"></div>
				</div>

				<div class="content">
					<div class="tabs">
						<ul>
							<li><a href="#tabs-1">First</a></li>
						</ul>
						<div id="tabs-1" class="tab">Example</div>
					</div>
				</div>

				<div class="footer ui-corner-bottom">
					<div class="status"></div>
					<div class="tools">
						<div class="ui-icon bell-icon">
							<div class="bell-slider"></div>
						</div>
						<div class="ui-icon mic-icon">
							<div class="mic-slider"></div>
						</div>
						<div class="ui-icon hp-icon">
							<div class="hp-slider"></div>
						</div>
						<div class="ui-icon settings-icon">
							<ul class="settings-menu">
								<li><a><div class="ui-icon accounts-icon">Accounts</div></a></li>
								<li><a><div class="ui-icon media-icon">Media</div></a></li>
								<li><a><div class="ui-icon codecs-icon">Codecs</div></a></li>
								<li><a><div class="ui-icon locales-icon">Language</div></a>
									<ul class="locales-menu">
										<li></li>
									</ul></li>
							</ul>
						</div>
					</div>
				</div>
				<div class="codecs-options options">
					<a class="close ui-widget-header ui-corner-all"> <span class="ui-icon ui-icon-closethick"></span>
					</a>
				</div>

				<div class="media-options options">
					<a class="close ui-widget-header ui-corner-all"> <span class="ui-icon ui-icon-closethick"></span>
					</a>
				</div>

				<div class="accounts-options options">
					<a class="close ui-widget-header ui-corner-all"> <span class="ui-icon ui-icon-closethick"></span>
					</a>
				</div>
			</div>
		</div>

		<div>
			<textarea id="log" rows="10" cols="100"></textarea>
			<div class="ui-widget">
				<div id="version" class="ui-state-highlight ui-corner-all">
					Linphone version: <span id="version_number"></span>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
