<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Linphone-JS</title>
<link rel="icon" type="image/png" href="css/images/linphone.png" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.17.custom.css" rel="stylesheet" />
<link type="text/css" href="css/linphone.css" rel="stylesheet" />
<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.scrollabletab.js"></script>
<script type="text/javascript" src="js/jsrender.js"></script>
<script type="text/javascript" src="js/linphone.js"></script>
<style type="text/css">
body {
	font: 62.5% "Trebuchet MS", sans-serif;
}

.tabs {
	font-size: .8em !important;
	width: auto;
	margin: 5px;
	padding: 0;
	border: 0 !important;
	overflow: hidden;
}

/*scrollable tabs css*/
.ui-scrollable-tabs {
	overflow: hidden;
	position: relative;
}

.ui-scrollable-tabs .ui-tabs-nav {
	width: 1000000px;
	padding: 1px 0 0 1px;
	border-left: none;
	border-right: none;
	padding-top: 1px;
	position: relative;
}

.ui-scrollable-tabs .ui-tabs .ui-tabs-closable li a {
	padding-right: 5px;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows {
	left: 0;
	margin: 0;
	margin: 0 5px;
	padding: 0;
	position: absolute;
	right: 0;
	top: 5px;
	height: 25px;
}

/*IE7 fix*/
*:first-child+html .ui-scrollable-tabs .ui-tabs-nav-arrows {
	z-index: 1;
}

.ui-scrollable-tabs .ui-tabs .ui-tabs-nav li {
	margin: 0 1px 0;
}

.ui-tabs-nav li .ui-tabs-close {
	float: left;
	margin-top: 3px;
	margin-right: 4px;
	border: none;
	cursor: pointer;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows .ui-tabs-arrow-next {
	float: right;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows .ui-tabs-arrow-previous {
	float: left;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows li {
	list-style: none;
	position: relative;
	cursor: pointer;
	margin: 0;
	padding: 0;
	display: none;
	z-index: 1;
	height: 23px;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows li a {
	display: block;
	margin-top: 3px;
}

.ui-scrollable-tabs .ui-tabs-nav-arrows li a:focus {
	outline: 0px;
}

/*End of scrollable tabs css*/
#version {
	font-size: 9px;
}

#version_number {
	font-weight: bold;
}
</style>
</head>
<body onload="load()">
	<script type="text/javascript">
		function plugin0() {
			return document.getElementById('plugin0');
		}
		plugin = plugin0;
		function addEvent(obj, name, func) {
			if (window.addEventListener) {
				obj.addEventListener(name, func, false);
			} else {
				obj.attachEvent("on" + name, func);
			}
		}

		function load() {

		}

		function addLog(message) {
			jQuery('#log').val(jQuery('#log').val() + message + '\n');
		}

		function pluginLoaded() {
			jQuery('#version_number').text(plugin().version);
			addEvent(plugin(), 'global_state_changed', global_state_changed);
			addEvent(plugin(), 'call_state_changed', call_state_changed);
			addEvent(plugin(), 'display_status', display_status);
			addEvent(plugin(), 'display_message', display_message);
			addEvent(plugin(), 'display_warning', display_warning);
			addEvent(plugin(), 'display_url', display_url);
			if (plugin().init() != 0) {
				alert("Plugin error!");
			} else {
				// Init volumes
				jQuery('.linphone .window .tools .mic-slider').slider('value', 100)
				plugin().set_rec_level(100)
				jQuery('.linphone .window .tools .hp-slider').slider('value', 100)
				plugin().set_play_level(100)
				addLog('Sip port: ' + plugin().sip_port)
			}
		}

		function global_state_changed(state, message) {
			addLog('State(' + state + '): ' + message)
			jQuery('.linphone .window .status').text(LinphoneGlobalStateText[state])
		}

		function call_state_changed(call, state, message) {
			addLog('Call(' + state + '): ' + message);
			var element = findCallTab(call);
			if (element) {
				element.html(jQuery('#LinphoneCall-' + LinphoneCallStateText[state]).render(element.data('data')))
			} else {
				addLog('Can\'t find call tab: ' + call);
			}
		}

		//registration_state_changed(LinphoneProxyConfig *cfg, LinphoneRegistrationState cstate, const char *message);
		//call_state_changed(LinphoneCall *call, LinphoneCallState cstate, const char *message);
		//notify_presence_recv(LinphoneFriend * lf);
		//new_subscription_request(LinphoneFriend *lf, const char *url);
		//auth_info_requested(const char *realm, const char *username);
		//call_log_updated(LinphoneCallLog *newcl);
		//text_received(LinphoneChatRoom *room, const LinphoneAddress *from, const char *message);
		//dtmf_received(LinphoneCall *call, int dtmf);
		//refer_received(const char *refer_to);
		//buddy_info_updated(LinphoneFriend *lf);
		//notify_recv(LinphoneCall *call, const char *from, const char *event);
		function display_status(message) {
			addLog('Status: ' + message);
		}

		function display_message(message) {
			addLog('Message: ' + message);
		}

		function display_warning(message) {
			addLog('Warning: ' + message);
		}

		function display_url(message, url) {
			addLog('Url: ' + message + ' - ' + url);
		}

		function findCallTab(obj) {
			var ret = null
			jQuery('#linphone .window .tabs .tab').each(function(index) {
				var element = jQuery(this)
				if (element.data('data') && element.data('data').obj == obj) {
					ret = element;
				}
			})
			return ret;
		}

		function call_invite(dest) {
			plugin().invite_async(dest, function() {
				return function(plugin, obj) {
					call_invite_callback(dest, obj)
				}
			}())
		}

		function call_invite_callback(dest, obj) {
			console.log("call_invite_callback")
			console.log(dest)
			console.log(obj)
			if (obj) {
				var call_number = jQuery.linphone.call_number
				console.log('Add tab call-' + call_number)
				var div = jQuery('<div id="call-'+call_number+'" class="tab"></div>')
				jQuery('#linphone .window .tabs').append(div)
						.tabs('add', '#call-' + call_number, 'Call ' + call_number);
				jQuery('#linphone .window .tabs').tabs('select', '#call-' + call_number)
				var element = jQuery('#linphone .window .tabs #call-' + call_number)
				element.data('data', {
					obj : obj,
					dest : dest
				})
				element.html(jQuery('#LinphoneCall-OutgoingInit').render(element.data('data'))) //Async invite force OutgoingInit 
				jQuery.linphone.call_number++
			}
		}

		jQuery(function() {
			
			$.fn.disableSelection = function() {
			    return this.each(function() {           
			        $(this).attr('unselectable', 'on')
			               .css({
			                   '-moz-user-select':'none',
			                   '-webkit-user-select':'none',
			                   'user-select':'none',
			                   '-ms-user-select':'none'
			               })
			               .each(function() {
			                   this.onselectstart = function() { return false; };
			               });
			    });
			};
			
			jQuery.linphone = {
				call_number : 1
			}
			// Tabs
			jQuery('.linphone .window .tabs').tabs({
				closable : true,
				scrollable : true
			})

			jQuery(".linphone .window .tools .hp-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					plugin().set_play_level(ui.value)
				}
			});
			jQuery(".linphone .window .tools .mic-slider").slider({
				orientation : 'vertical',
				change : function(event, ui) {
					plugin().set_rec_level(ui.value)
				}
			});

			jQuery(document).on('click', '.linphone .window .dial-button', function(event) {
				call_invite(jQuery(event.target).parent().find('.dest').val())
			})

			jQuery(document).on('click', '.linphone .window .teminate-button', function(event) {
				element = jQuery(event.target).parents('.tab')
				if (element && element.data('data')) {
					plugin().terminate_call(element.data('data').obj)
				} else {
					addLog('Can\'t find call: ' + element);
				}
			})

			jQuery(document).on('click', '.linphone .window .ui-tabs-close .ui-icon', function(event) {
				var tab = jQuery(event.target).parents('li')
				var tabId = tab.find('a').attr('href')
				var element = jQuery('#linphone .window .tabs ' + tabId)
				if (element && element.data('data')) {
					plugin().terminate_call(element.data('data').obj)
				} else {
					addLog('Can\'t find call: ' + element);
				}
				jQuery('#linphone .window .tabs ').tabs('remove', tab.prevAll('li').length);
			})

			jQuery('.linphone .window .tools .hp-icon').click(function(event) {
				var element = jQuery('.linphone .window .tools .hp-slider')
				element.fadeIn('fast');
			})

			jQuery('.linphone .window .tools .mic-icon').click(function(event) {
				var element = jQuery('.linphone .window .tools .mic-slider')
				element.fadeIn('fast');
			})

			jQuery(".linphone .window .tools .settings-menu").menu();

			jQuery('.linphone .window .tools .settings-icon').click(function(event) {
				var element = jQuery('.linphone .window .tools .settings-menu')
				element.fadeIn('fast');
			})

			jQuery('.linphone .window .tools').disableSelection()
			
			jQuery('.linphone .window .options .close').click(function(event) {
				var element = jQuery('.linphone .window .options')
				element.fadeOut('fast');
			})

			jQuery('.linphone .window .options .close').hover(function() {
				jQuery(this).addClass("ui-state-hover");
			}, function() {
				jQuery(this).removeClass("ui-state-hover");
			})

			jQuery('html').click(
					function(event) {
						var target = jQuery(event.target);
						if (target.length) {
							if (jQuery('.linphone .window .tools .hp-icon').length
									&& target[0] != jQuery('.linphone .window .tools .hp-icon')[0])
								jQuery('.linphone .window .tools .hp-slider').fadeOut('fast');

							if (jQuery('.linphone .window .tools .mic-icon').length
									&& target[0] != jQuery('.linphone .window .tools .mic-icon')[0])
								jQuery('.linphone .window .tools .mic-slider').fadeOut('fast');

							if (jQuery('.linphone .window .tools .settings-icon').length
									&& target[0] != jQuery('.linphone .window .tools .settings-icon')[0])
								jQuery('.linphone .window .tools .settings-menu').fadeOut('fast');
						}
					});
		})
		//show(LinphoneCore *lc);
		//call_encryption_changed(LinphoneCall *call, bool_t on, const char *authentication_token);
	</script>
	<script id="LinphoneCall-Idle" type="text/x-jquery-tmpl">
Idle <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-IncomingReceived" type="text/x-jquery-tmpl">
IncomingReceived <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-OutgoingInit" type="text/x-jquery-tmpl">
OutgoingInit <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-OutgoingProgress" type="text/x-jquery-tmpl">
OutgoingProgress <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-OutgoingRinging" type="text/x-jquery-tmpl">
OutgoingRinging <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-OutgoingEarlyMedia" type="text/x-jquery-tmpl">
OutgoingEarlyMedia <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Connected" type="text/x-jquery-tmpl">
Connected <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-StreamsRunning" type="text/x-jquery-tmpl">
StreamsRunning <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Pausing" type="text/x-jquery-tmpl">
Pausing <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Paused" type="text/x-jquery-tmpl">
Paused <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Resuming" type="text/x-jquery-tmpl">
Resuming <b>{{=dest}}</b>
<div class="teminate-button"></div>
</script>
	<script id="LinphoneCall-Refered" type="text/x-jquery-tmpl">
Refered <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Error" type="text/x-jquery-tmpl">
Error <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-End" type="text/x-jquery-tmpl">
End <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-PausedByRemote" type="text/x-jquery-tmpl">
PausedByRemote <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-UpdatedByRemote" type="text/x-jquery-tmpl">
UpdatedByRemote <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-IncomingEarlyMedia" type="text/x-jquery-tmpl">
IncomingEarlyMedia <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Updated" type="text/x-jquery-tmpl">
Updated <b>{{=dest}}</b>
</script>
	<script id="LinphoneCall-Released" type="text/x-jquery-tmpl">
Call end: <b>{{=dest}}</b>
</script>

	<div>
		<object id="plugin0" type="application/x-linphone" width="0" height="0">
			<param name="onload" value="pluginLoaded" />
			* linphone-js
		</object>
		<br />

		<div class="linphone ui-widget" id="linphone">
			<div class="window ui-corner-all">
				<div class="header ui-corner-top">
					<div class="text">Linphone</div>
				</div>

				<div class="composer">
					<input type="text" class="dest" title="destination" />
					<div class="ui-icon dial-button"></div>
				</div>

				<div class="content">
					<div class="tabs">
						<ul>
							<li><a href="#tabs-1">First</a></li>
						</ul>
						<div id="tabs-1" class="tab">Example</div>
					</div>
				</div>

				<div class="footer ui-corner-bottom">
					<div class="status"></div>
					<div class="tools">
						<div class="ui-icon mic-icon">
							<div class="mic-slider"></div>
						</div>
						<div class="ui-icon hp-icon">
							<div class="hp-slider"></div>
						</div>
						<div class="ui-icon settings-icon">
							<ul class="settings-menu">
								<li><a class="ui-icon account-icon">Accounts</a></li>
								<li><a class="ui-icon language-icon">Language</a></li>
							</ul>
						</div>
					</div>

					<div class="options">
						<a class="close ui-widget-header ui-corner-all"> <span class="ui-icon ui-icon-closethick"></span>
						</a>
					</div>
				</div>
			</div>
		</div>

		<div>
			<textarea id="log" rows="10" cols="100"></textarea>
			<div class="ui-widget">
				<div id="version" class="ui-state-highlight ui-corner-all">
					Linphone version: <span id="version_number"></span>
				</div>
			</div>
		</div>
</body>
</html>
